name: Build Linux Application

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode (onefile/onedir)'
        required: false
        default: 'onefile'
        type: choice
        options:
          - onefile
          - onedir

env:
  PYTHON_VERSION: "3.11"
  APP_NAME: "FatigueDetectionApp"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libgtk-3-dev \
          libwebkit2gtk-4.0-dev \
          libappindicator3-dev \
          librsvg2-dev \
          patchelf \
          desktop-file-utils \
          libgdk-pixbuf2.0-dev \
          fakeroot \
          dpkg-dev

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements-build.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements-build.txt

    - name: Run tests
      run: |
        if [ -d "tests" ]; then
          python -m pytest tests/ -v --tb=short
        else
          echo "No tests found, skipping..."
        fi
      continue-on-error: true

    - name: Build application
      run: |
        chmod +x build-linux.sh
        BUILD_MODE="${{ github.event.inputs.build_mode || 'onefile' }}"
        ./build-linux.sh --$BUILD_MODE --skip-tests

    - name: Test executable
      run: |
        EXECUTABLE="dist/${{ env.APP_NAME }}"
        if [ -f "$EXECUTABLE" ]; then
          echo "✅ Executable created: $EXECUTABLE"
          ls -lh "$EXECUTABLE"
          file "$EXECUTABLE"
        else
          echo "❌ Executable not found: $EXECUTABLE"
          exit 1
        fi

    - name: Create AppImage
      if: matrix.python-version == '3.11'
      run: |
        # Download linuxdeploy if not present
        if [ ! -f "linuxdeploy" ]; then
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
        fi
        
        ./build-linux.sh --package-only

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-python${{ matrix.python-version }}-build
        path: |
          dist/
          *.AppImage
          *.deb
        retention-days: 7

    - name: Create Release Assets
      if: startsWith(github.ref, 'refs/tags/') && matrix.python-version == '3.11'
      run: |
        TAG="${{ github.ref_name }}"
        
        # Compress executable
        if [ -f "dist/${{ env.APP_NAME }}" ]; then
          tar -czf "${{ env.APP_NAME }}-$TAG-linux-x86_64.tar.gz" -C dist/ "${{ env.APP_NAME }}"
        fi
        
        # Rename AppImage
        if [ -f "${{ env.APP_NAME }}-"*".AppImage" ]; then
          mv "${{ env.APP_NAME }}-"*".AppImage" "${{ env.APP_NAME }}-$TAG-linux-x86_64.AppImage"
        fi
        
        # Rename DEB package
        if [ -f "driver-fatigue-detection_"*"_amd64.deb" ]; then
          mv driver-fatigue-detection_*_amd64.deb "${{ env.APP_NAME }}-$TAG-linux-amd64.deb"
        fi

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/') && matrix.python-version == '3.11'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.APP_NAME }}-*.tar.gz
          ${{ env.APP_NAME }}-*.AppImage
          ${{ env.APP_NAME }}-*.deb
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-packages:
    runs-on: ubuntu-latest
    needs: build-linux
    if: github.event_name == 'push'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-python3.11-build
        path: ./

    - name: Test AppImage
      run: |
        if [ -f "*.AppImage" ]; then
          APPIMAGE=$(ls *.AppImage | head -1)
          chmod +x "$APPIMAGE"
          echo "Testing AppImage: $APPIMAGE"
          # Basic test - just verify it doesn't crash immediately
          timeout 10s ./"$APPIMAGE" --version || echo "AppImage test completed"
        fi

    - name: Test DEB package
      run: |
        if [ -f "*.deb" ]; then
          DEB_PACKAGE=$(ls *.deb | head -1)
          echo "Testing DEB package: $DEB_PACKAGE"
          dpkg-deb --info "$DEB_PACKAGE"
          dpkg-deb --contents "$DEB_PACKAGE"
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: build-linux
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-python3.11-build
        path: dist/

    - name: Run security scan
      run: |
        echo "Running basic security checks..."
        
        EXECUTABLE="dist/${{ env.APP_NAME }}"
        if [ -f "$EXECUTABLE" ]; then
          echo "Executable SHA256:"
          sha256sum "$EXECUTABLE"
          
          echo "File information:"
          file "$EXECUTABLE"
          
          echo "Dependencies:"
          ldd "$EXECUTABLE" | head -20 || echo "Static binary or dependencies not found"
        fi
