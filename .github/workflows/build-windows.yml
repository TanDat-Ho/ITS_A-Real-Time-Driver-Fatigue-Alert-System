name: Build Windows Application

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode (onefile/onedir)'
        required: false
        default: 'onefile'
        type: choice
        options:
          - onefile
          - onedir

env:
  PYTHON_VERSION: "3.11"
  APP_NAME: "FatigueDetectionApp"

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        architecture: [x64, x86]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        architecture: ${{ matrix.architecture }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ matrix.architecture }}-${{ hashFiles('**/requirements-build.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.architecture }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements-build.txt

    - name: Run tests
      run: |
        if (Test-Path "tests") {
          python -m pytest tests/ -v --tb=short
        } else {
          Write-Host "No tests found, skipping..."
        }
      continue-on-error: true

    - name: Build application
      run: |
        $buildMode = "${{ github.event.inputs.build_mode || 'onefile' }}"
        .\build-windows.ps1 -BuildMode $buildMode -Architecture ${{ matrix.architecture }} -SkipTests

    - name: Test executable
      run: |
        $exePath = "dist\${{ env.APP_NAME }}.exe"
        if (Test-Path $exePath) {
          Write-Host "✅ Executable created: $exePath"
          $fileInfo = Get-Item $exePath
          Write-Host "File size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
        } else {
          Write-Error "❌ Executable not found: $exePath"
          exit 1
        }

    - name: Create installer
      if: matrix.architecture == 'x64'
      run: |
        if (Get-Command "makensis.exe" -ErrorAction SilentlyContinue) {
          makensis.exe installer\setup.nsi
        } else {
          Write-Host "NSIS not found, skipping installer creation"
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-${{ matrix.architecture }}-build
        path: |
          dist/
          *.exe
        retention-days: 7

    - name: Create Release Assets
      if: startsWith(github.ref, 'refs/tags/')
      shell: powershell
      run: |
        $tag = "${{ github.ref_name }}"
        $arch = "${{ matrix.architecture }}"
        
        # Compress build artifacts
        if (Test-Path "dist\${{ env.APP_NAME }}.exe") {
          Compress-Archive -Path "dist\${{ env.APP_NAME }}.exe" -DestinationPath "${{ env.APP_NAME }}-$tag-windows-$arch.zip"
        }
        
        # Find installer
        $installer = Get-ChildItem -Path "." -Name "*setup*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($installer) {
          Copy-Item $installer.Name "${{ env.APP_NAME }}-$tag-windows-$arch-installer.exe"
        }

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.APP_NAME }}-*.zip
          ${{ env.APP_NAME }}-*-installer.exe
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    runs-on: windows-latest
    needs: build-windows
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-x64-build
        path: dist/

    - name: Run security scan
      run: |
        # Basic security check - scan for suspicious patterns
        Write-Host "Running basic security checks..."
        
        $exePath = "dist\${{ env.APP_NAME }}.exe"
        if (Test-Path $exePath) {
          $fileHash = Get-FileHash $exePath -Algorithm SHA256
          Write-Host "Executable SHA256: $($fileHash.Hash)"
          
          # Check file signature (if signed)
          $signature = Get-AuthenticodeSignature $exePath
          Write-Host "Code signature status: $($signature.Status)"
        }

  notify:
    runs-on: ubuntu-latest
    needs: [build-windows, security-scan]
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Notify build status
      run: |
        echo "Build completed with status: ${{ needs.build-windows.result }}"
        echo "Security scan status: ${{ needs.security-scan.result }}"
